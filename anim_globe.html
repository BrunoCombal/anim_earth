<!DOCTYPE html>
<!-- sources:
https://www.jasondavies.com/maps/zoom/
http://bl.ocks.org/mbostock/4183330
-->
<html>
  <head>
    <meta charset="utf-8">
    <style>
     .announce {
       font-family:Verdana, sans-serif;
       font-size:16px;
       text-align:center;
     }
     .announce h1{
       font-size:20px;
       font-weight:bold;
       text-align:center;
     }
     .announce h2{
       font-size:24px;
     }
     #legendRanges{
       width: 600px;
       margin:auto auto;
     }
     #legendRanges ul{
       margin: 0;
       padding: 0;
       list-style-type: none;
       text-align: left;
     }
     #legendRanges ul li{
       float:left;
       padding-left:10px;
       font: 10px Verdana;
     }
     .legendText{
       position: relative;
       top: 4px;
     }
     #legendRanges ul li {
       width:90px;
     }
     #legendRanges ul li div{
       float:left;
       margin-right:5px;
     }
     #legendRanges ul li div span{
       position:relative;
       top:5px;
     }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  </head>
  <body>


    <div class="announce" style="width:950px">
      <h1>We are all sharing the same ocean</h1>
      However human activity is not even across the globe,<br/>
      incurring variable global and local risk on ocean services<br/>
      Discover detailed analysis for <a href="onesharedocean.org/open_ocean" target="_top" style="font-weight:bold">Open Ocean</a> and <a href="oneSharedocean.org/lmes" target="_top" style="font-weight:bold">Large Marine Ecosystems</a><br/>
      <h1>OneSharedOcean</h1>
    </div>

    <div id="canvas"></div>
    <div style="margin:0 auto; width:110px; padding:0; padding-bottom:10px; font-family: Verdana; font-size:11px">Risk level</div>
    <div style"float:left" id="legendRanges">
      <ul>
        <li><div style="border-radius:50%; width:20px; height:20px; padding:0px; background:#D8232A; border: 1px solid #CBCCCB; color:#FFFFFF; text-align:center; font: 10px Arial, sans-serif;"><span style="margin: auto auto;"></span></div> <span class="legendText">Very high</span></li>
        <li><div style="border-radius:50%; width:20px; height:20px; padding:0px; background:#EE9F42; border: 1px solid #CBCCCB; color:#FFFFFF; text-align:center; font: 10px Arial, sans-serif;"><span style="margin: auto auto;"></span></div> <span class="legendText">High</span></li>
        <li><div style="border-radius:50%; width:20px; height:20px; padding:0px; background:#E4E344; border: 1px solid #CBCCCB; color:#FFFFFF; text-align:center; font: 10px Arial, sans-serif;"><span style="margin: auto auto;"></span></div> <span class="legendText">Moderately large</span></li>
        <li><div style="border-radius:50%; width:20px; height:20px; padding:0px; background:#78BB4B; border: 1px solid #CBCCCB; color:#FFFFFF; text-align:center; font: 10px Arial, sans-serif;"><span style="margin: auto auto;"></span></div> <span class="legendText">Low</span></li>
        <li><div style="border-radius:50%; width:20px; height:20px; padding:0px; background:#5FBADD; border: 1px solid #CBCCB; color:#FFFFFF; text-align:center; font: 10px Arial, sans-serif;"><span style="margin: auto auto;"></span></div> <span class="legendText">Very low</span></li>

      </ul>
    </div>


    <script>
     var width = 750,
     height = 500;
     var riskColor=["#5fbadd","#78bb4b","#e4e344","#ee9f42","#d8232a"];
     var projection = d3.geo.orthographic()
                            .scale(248)
                            .clipAngle(90);

     var canvas = d3.select("#canvas").append("canvas")
                    .attr("width", width)
                    .attr("height", height);

     var c = canvas.node().getContext("2d");

     var path = d3.geo.path()
                      .projection(projection)
                      .context(c);

     queue().defer(d3.json,"./eeztopojson.json")
                      .defer(d3.json, "./world-110m.json")
                      .defer(d3.json,"./lmes66.topojson.json")
                      .defer(d3.tsv, "./risk.tsv")
                      .await(ready);


     function ready(error, eezs, world, lmes, risk) {
       if (error) throw error;

       var globe = {type: "Sphere"};
       land = topojson.feature(world, world.objects.land);
       var countries = topojson.feature(world, world.objects.countries).features;
       var i = -1,
       n = countries.length;
       var lmes=topojson.feature(lmes, lmes.objects.lmes66);
       var eez=topojson.feature(eezs, eezs.objects.eez);
       var EEZ=topojson.feature(eezs, eezs.objects.eez).features;
       console.log(EEZ);
       console.log(EEZ[2]);
       console.log(EEZ[2].properties.ID);
       var N=risk.length,
       maxRisk=0;
       for (var ii=0; ii<N; ii++){
         if (risk[ii].Total_Risk>maxRisk) maxRisk=risk[ii].Total_Risk;
       }
       var thisEEZpos=0;

       (function transition() {
         d3.transition()
           .duration(1250)
           .each("start", function() {
             // search for this eez_id in the list
             //thisEEZid=risk[i].eez_id;
	     i=(i+1)%N
             thisEEZpos = i;
	     

             //             return i;
           })
           .tween("rotate", function() {
             var p = d3.geo.centroid(EEZ[thisEEZpos]),
             r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
             return function(t) {
               projection.rotate(r(t));
               thisColor = riskColor[Math.round(5*risk[i].Total_Risk/maxRisk)];
               c.clearRect(0, 0, width, height);
               c.fillStyle = "#f9f6d8", c.beginPath(), path(land), c.fill();
               // EEZ
               //c.fillStyle = "#cbcccb", c.beginPath(), path(eez),c.fill();
               c.strokeStyle = thisColor, c.lineWidth=.5, c.beginPath(),path(EEZ[thisEEZpos]),c.stroke();
               c.fillStyle = thisColor, c.beginPath(), path(EEZ[thisEEZpos]), c.fill();

               // lmes
               c.strokeStyle = "#a0cbd1", c.lineWidth=1.75, c.beginPath(),path(lmes),c.stroke();

               // globe frame
               c.strokeStyle = "#a5bfdd", c.lineWidth = 2, c.beginPath(), path(globe), c.stroke();
             };
           })
           .transition()
           .each("end", transition);
       })();

     }

    </script>

  </body>
</html>
